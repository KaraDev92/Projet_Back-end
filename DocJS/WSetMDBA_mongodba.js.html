<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: WSetMDBA/mongodba.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: WSetMDBA/mongodba.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict"


/** module MongoDB 
 * @module mongodba 
 * */

const { MongoClient, ServerApiVersion } = require("mongodb");

require('dotenv').config();

/** variables connexion à MongoDB Atlas
 * @constant {url} uri - url de connexion à la base de données
 * @constant {Object} client - instance de client MongoDB
 * @constant {Db} database - référence de la base de données
 * @constant {Collection&lt;Document>} joueurs - référence de la collection
 * */
// eslint-disable-next-line no-undef
const uri = process.env.MONGODB_CONNECTION_STRING;
const client = new MongoClient(uri, {
    serverApi: {
        version: ServerApiVersion.v1,
        strict: true,
        deprecationErrors: true,
    }
});
const database = client.db('projet_back-end');
const joueurs = database.collection('chifoumi');

/**fonction pour récupérer le leaderboard
 * @async
 * @function chercherLeaderboard
 * @returns {Array} leaderboard - extraction de la base de données
 */
async function chercherLeaderboard() {
    try {
      await client.connect();
      const options = { projection: { _id: 0, pseudo: 1, score:1} };
      const cursor = joueurs.find({}, options).sort({score:-1});
      const leaderboard = await cursor.toArray();
      return leaderboard;
    } catch (error){
      console.log('chercher leaderboard :', error);
      return [{pseudo: '---', score: '---'}];
    } finally {
      await client.close();
    }
  };

/** fonction de recherche si le pseudo fourni existe déjà dans la base Atlas
 * @async
 * @function chercherJoueur
 * @param {string} nom - pseudo saisi par le client
 * @returns {boolean}
 */ 
const chercherJoueur = async function (nom) {
    try {
        await client.connect();
        const options = { projection: { _id: 0, pseudo: 1}};
        const cursor = await joueurs.findOne({pseudo : nom}, options);
        console.log("joueur trouvé :", cursor);
        if (cursor === null) {
            joueurs.insertOne({pseudo: nom, score: 0});
            return false
        } else {
            return true
        }
    } catch (error){
        console.log('chercher joueur BDD : ', error);
        return false
    } finally {
        await client.close();
    }
};

/** fonction supprimant les pseudos ayant un score de 0
 * @async
 * @function purgerBDDdesZero
 */
const purgerBDDdesZero = async function() {
    try {
        await client.connect();
        await joueurs.deleteMany({score : 0});
        console.log("ménage fait dans le leaderboard");
    } catch (error){
        console.log('purger les 0 :', error);
    } finally {
        await client.close();
    }
}

/** fonction enregistrant les scores dans la base de données
 * @async
 * @function enregistrerScore
 * @param {string} pseudo - pseudo du joueur
 * @param {number} score - score du joueur
 */
const enregistrerScore = async function (pseudo, score) {
    try {
        await client.connect();
        joueurs.updateOne({pseudo: pseudo}, {$set: {score: score}}, {upsert : true});
    } catch (error){
        console.log('enregistrer score :', error);
    } finally {
        await client.close();
    }
};

module.exports.chercherLeaderboard = chercherLeaderboard;
module.exports.chercherJoueur = chercherJoueur;
module.exports.purgerBDDdesZero = purgerBDDdesZero;
module.exports.enregistrerScore = enregistrerScore;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-indexRouter.html">indexRouter</a></li><li><a href="module-jouerRouter.html">jouerRouter</a></li><li><a href="module-logique_jeu.html">logique_jeu</a></li><li><a href="module-mongodba.html">mongodba</a></li><li><a href="module-serveurWS.html">serveurWS</a></li><li><a href="module-variables.html">variables</a></li></ul><h3>Classes</h3><ul><li><a href="module-logique_jeu-Partie.html">Partie</a></li></ul><h3>Events</h3><ul><li><a href="module-serveurWS-.html#event:error">error</a></li></ul><h3>Global</h3><ul><li><a href="global.html#baliseMessage">baliseMessage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Mon Sep 30 2024 19:28:44 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
